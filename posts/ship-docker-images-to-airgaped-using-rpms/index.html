<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Ship Docker images to airgapped systems using rpms" /><meta property="og:locale" content="en" /><meta name="description" content="Configuring and managing docker images in airgapped system can be challending. Let’s see how we can ease IT Admin’s job by letting them use what they have been using for years now." /><meta property="og:description" content="Configuring and managing docker images in airgapped system can be challending. Let’s see how we can ease IT Admin’s job by letting them use what they have been using for years now." /><link rel="canonical" href="https://blogs.bikramjs.in/posts/ship-docker-images-to-airgaped-using-rpms/" /><meta property="og:url" content="https://blogs.bikramjs.in/posts/ship-docker-images-to-airgaped-using-rpms/" /><meta property="og:site_name" content="Bikramjeet Singh" /><meta property="og:image" content="https://blogs.bikramjs.in/assets/img/headers/docker-image-rpm.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-07-26T08:00:00+05:30" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://blogs.bikramjs.in/assets/img/headers/docker-image-rpm.png" /><meta property="twitter:title" content="Ship Docker images to airgapped systems using rpms" /><meta name="twitter:site" content="@bikram990" /><meta name="google-site-verification" content="68w0jTUv9wKPY0qAAHw0OkALHv5UCZdkZ2jv7PirDrc" /><meta name="msvalidate.01" content="5C1D36025597B9D33CC34142BE0DF834" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-07-26T08:00:00+05:30","datePublished":"2025-07-26T08:00:00+05:30","description":"Configuring and managing docker images in airgapped system can be challending. Let’s see how we can ease IT Admin’s job by letting them use what they have been using for years now.","headline":"Ship Docker images to airgapped systems using rpms","image":"https://blogs.bikramjs.in/assets/img/headers/docker-image-rpm.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://blogs.bikramjs.in/posts/ship-docker-images-to-airgaped-using-rpms/"},"url":"https://blogs.bikramjs.in/posts/ship-docker-images-to-airgaped-using-rpms/"}</script><title>Ship Docker images to airgapped systems using rpms | Bikramjeet Singh</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Bikramjeet Singh"><meta name="application-name" content="Bikramjeet Singh"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "635e2d7e1ab649acb4116a66f454351f"}' ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Bikramjeet Singh</a><p class="site-subtitle fst-italic mb-0">Software Developer</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/bikram990" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/bikram990/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/1578528/bikram990" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Ship Docker images to airgapped systems using rpms</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Ship Docker images to airgapped systems using rpms</h1><p class="post-desc fw-light mb-4">Configuring and managing `docker` images in airgapped system can be challending. Let's see how we can ease IT Admin's job by letting them use what they have been using for years now.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1753497000" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jul 26, 2025 </time> </span><div class="mt-3 mb-3"> <a href="/assets/img/headers/docker-image-rpm.png" class="popup img-link preview-img shimmer"><img src="/assets/img/headers/docker-image-rpm.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/bikram990">Bikramjeet Singh</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2279 words" > <em>12 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Ship Docker images to airgapped systems using rpms</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Ship Docker images to airgapped systems using rpms</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>In previous blog we have gone through manual steps of exporting a container and importing it on an airgapped machine. In this blog we will go through how we can remove the barier of learning <code class="language-plaintext highlighter-rouge">docker</code> for the IT Admins.</p><h2 id="the-barier"><span class="me-2">The Barier</span><a href="#the-barier" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Over many years IT Admins have been installing the software via standard packages like <code class="language-plaintext highlighter-rouge">rpm</code>, <code class="language-plaintext highlighter-rouge">deb</code>, <code class="language-plaintext highlighter-rouge">pkg</code> etc. Now they have to learn <code class="language-plaintext highlighter-rouge">docker</code> for the new applications which are being shipped on <code class="language-plaintext highlighter-rouge">docker</code>.</p><p>Earlier they used to manage the status of different services running on a machine via <code class="language-plaintext highlighter-rouge">service</code> or <code class="language-plaintext highlighter-rouge">systemctl</code> command but now they have to use <code class="language-plaintext highlighter-rouge">docker ps</code> to know the status or a service.</p><p>They have been using <code class="language-plaintext highlighter-rouge">journalctl</code> to view the logs of a service, but now they have to use <code class="language-plaintext highlighter-rouge">docker logs</code>. Let’s see how we can help them use docker via these standard tools.</p><h2 id="creating-rpm-for-a-docker-service"><span class="me-2">Creating RPM for a <code class="language-plaintext highlighter-rouge">docker</code> service</span><a href="#creating-rpm-for-a-docker-service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="prerequiste"><span class="me-2">Prerequiste</span><a href="#prerequiste" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We will need following packages to be installed for building an RPM.</p><ul><li><code class="language-plaintext highlighter-rouge">podman</code> or <code class="language-plaintext highlighter-rouge">docker</code> for pulling and exporting the images.<li><code class="language-plaintext highlighter-rouge">rpmdevtools</code> for setting up the RPM build area and creating spec file.<li><code class="language-plaintext highlighter-rouge">rpm-build</code> for building the RPM.<li><code class="language-plaintext highlighter-rouge">dnf-plugins-core</code> for downloading any dependent RPMs like <code class="language-plaintext highlighter-rouge">podman</code> or <code class="language-plaintext highlighter-rouge">curl</code> etc.</ul><h3 id="preparing-for-building-rpm"><span class="me-2">Preparing for Building RPM</span><a href="#preparing-for-building-rpm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before we start building RPM we have to know what an RPM is. RPM stands for RedHat Package Manager. RPM is a package manager which allows you to ship your software packaged as an <code class="language-plaintext highlighter-rouge">.rpm</code> file. RPM packages can be of 2 types Binary packages and Source packages. Binary packages are the type of packages where you package pre-built binaries and you don’t have to compile or download anything. Source packages are the type of packages where you have to package source code into the package and then compile and install it on the target machine.</p><p>For this exercise we will be building a Binary package using <code class="language-plaintext highlighter-rouge">nginx</code> image. We are not building Source package as the application is already compiled and installed inside the container.</p><p>You can use <code class="language-plaintext highlighter-rouge">rpmdev-setuptree</code> to setup a build area. By default it will treat your <code class="language-plaintext highlighter-rouge">$HOME/rpmbuild</code> as the build area. In order to change this path you have to change <code class="language-plaintext highlighter-rouge">HOME</code> env variable before running this command.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">HOME</span><span class="o">=</span>/tmp/docker-to-rmp rpmdev-setuptree

<span class="nb">ls</span> <span class="nt">-la</span> /tmp/docker-to-rmp/
</pre></table></code></div></div><p>It will create a directory structure like mentioned below:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>.rpmmacros
rpmbuild/
├── BUILD
├── RPMS
├── SOURCES
├── SPECS
└── SRPMS
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">BUILD</code> folder is where you will build your code or have intermediate files.<li><code class="language-plaintext highlighter-rouge">RPMS</code> folder will contain the RPM for binary type rpms.<li><code class="language-plaintext highlighter-rouge">SOURCES</code> folder should have all the source code which you want to use for your build.<li><code class="language-plaintext highlighter-rouge">SPECS</code> folder should have your rpm spec<li><code class="language-plaintext highlighter-rouge">SRPMS</code> folder will contain the RPM, if you are building the source rpm.<li><code class="language-plaintext highlighter-rouge">.rpmmacros</code> file is macro file.</ul><p>The next step is to create a spec file. Spec file contains the package specification like package name, version, vendor, scripts, changelog etc.</p><p>You can use <code class="language-plaintext highlighter-rouge">rpmdev-newspec</code> command to create a spec file.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /tmp/docker-to-rmp/rpmbuild/SPECS
rpmdev-newspec <span class="nt">-o</span> nginx.spec
<span class="nb">cat </span>nginx.spec
</pre></table></code></div></div><p>Above command will create a minimal spec file which looks like below:</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="n">Name</span>:           <span class="n">nginx</span>
<span class="n">Version</span>:
<span class="n">Release</span>:        <span class="m">1</span>%{?<span class="n">dist</span>}
<span class="n">Summary</span>:

<span class="n">License</span>:
<span class="n">URL</span>:
<span class="n">Source0</span>:

<span class="n">BuildRequires</span>:
<span class="n">Requires</span>:

%<span class="n">description</span>


%<span class="n">prep</span>
%<span class="n">autosetup</span>


%<span class="n">build</span>
%<span class="n">configure</span>
%<span class="n">make_build</span>


%<span class="n">install</span>
<span class="n">rm</span> -<span class="n">rf</span> $<span class="n">RPM_BUILD_ROOT</span>
%<span class="n">make_install</span>


%<span class="n">files</span>
%<span class="n">license</span> <span class="n">add</span>-<span class="n">license</span>-<span class="n">file</span>-<span class="n">here</span>
%<span class="n">doc</span> <span class="n">add</span>-<span class="n">docs</span>-<span class="n">here</span>



%<span class="n">changelog</span>
* <span class="n">Sat</span> <span class="n">Jul</span> <span class="m">25</span> <span class="m">2025</span> <span class="n">root</span>
-
</pre></table></code></div></div><p>By default <code class="language-plaintext highlighter-rouge">rpmdev-newspec</code> command creates the spec file suitable for Source package. We would need to modify it for our needs.</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="n">Name</span>:           <span class="n">nginx</span>
<span class="n">Version</span>:        <span class="m">1</span>.<span class="m">28</span>
<span class="n">Release</span>:        <span class="m">0</span>
<span class="n">Summary</span>:        <span class="n">nginx</span> <span class="n">container</span> <span class="n">packaged</span> <span class="n">as</span> <span class="n">rpm</span>
<span class="n">Group</span>:		      <span class="n">Applications</span>/<span class="n">System</span>
<span class="n">License</span>:	      <span class="n">MIT</span>
<span class="n">Vendor</span>:		      <span class="n">Bikramjeet</span> <span class="n">Singh</span>
<span class="n">URL</span>:		        <span class="n">http</span>://<span class="n">blogs</span>.<span class="n">bikramjs</span>.<span class="n">in</span>/
<span class="n">Packager</span>:	      <span class="n">Software</span> <span class="n">Group</span> &lt;<span class="n">packager</span>@<span class="n">blogs</span>.<span class="n">bikramjs</span>.<span class="n">in</span>&gt;
<span class="n">BuildArch</span>:      <span class="n">noarch</span>
<span class="n">Provides</span>:       <span class="n">nginx</span>

%<span class="n">description</span>
<span class="n">nginx</span> <span class="n">container</span> <span class="n">packaged</span> <span class="n">as</span> <span class="n">rpm</span>

%<span class="n">pre</span>

%<span class="n">install</span>

%<span class="n">post</span>

%<span class="n">files</span>
%<span class="n">defattr</span>(-,<span class="n">root</span>,<span class="n">root</span>,-) <span class="c"># Tell RPM manager that the default owner of all the files is root
</span>%<span class="n">dir</span>
/<span class="n">opt</span>/<span class="n">docker</span>-<span class="n">rpm</span>/<span class="n">nginx</span> <span class="c"># Tell RPM package manger that this RPM is managing this directory and everything under it
</span>

%<span class="n">preun</span>

%<span class="n">postun</span>

%<span class="n">changelog</span>
* <span class="n">Mon</span> <span class="n">Jul</span> <span class="m">21</span> <span class="m">2025</span> <span class="n">Bikramjeet</span> <span class="n">Singh</span> &lt;<span class="n">packager</span>@<span class="n">blogs</span>.<span class="n">bikramjs</span>.<span class="n">in</span>&gt;
- <span class="n">Sample</span> <span class="n">changelog</span>
</pre></table></code></div></div><blockquote class="prompt-tip"><p>We can cache this spec file instead of generating it for each build.</p></blockquote><h3 id="automating-image-import-and-clean-up"><span class="me-2">Automating image import and clean up</span><a href="#automating-image-import-and-clean-up" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now the next thing is to import the docker image and make it available for use and manage the whole lifecycle of the image. RPM spec file has many script macros which can be used to automate stuff at variaous stages. Let’s outline what do we need to do and see which script makes sense for them:</p><ul><li><p>We need to bundle the image archive into the RPM. <code class="language-plaintext highlighter-rouge">%install</code> runs at RPM build time for Binary package and RPM installation for Source package. This is the perfect place to export the image.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>podman image pull docker.io/library/nginx:1.28
podman image save docker.io/library/nginx:1.28 <span class="nt">-o</span> <span class="s2">"%{buildroot}/opt/docker-rpm/nginx/nginx-1.28.tar"</span>
</pre></table></code></div></div><li><p>We need to import the image archive on target system where we will install the RPM. <code class="language-plaintext highlighter-rouge">%post</code> runs after installing the RPM. That means we will have our image archive available at <code class="language-plaintext highlighter-rouge">/opt/docker-rpm/nginx/nginx-1.28.tar</code> when this step is being run.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>podman load <span class="nt">-i</span> <span class="s2">"/opt/docker-rpm/nginx/nginx-1.28.tar"</span>
</pre></table></code></div></div><li><p>We need to recreate the running containers when upgrading. Here first we need to identify containers which are running the old image for this we would need to split this section into <code class="language-plaintext highlighter-rouge">%pre</code> and <code class="language-plaintext highlighter-rouge">%post</code> scripts. <code class="language-plaintext highlighter-rouge">%pre</code> script runs before installing the package and both <code class="language-plaintext highlighter-rouge">%pre</code> and <code class="language-plaintext highlighter-rouge">%post</code> scripts get 1 argument which tells them if it is a fresh install or upgrade scenario.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>%pre
<span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Pre Installing nginx"</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 2 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Pre Upgrading nginx"</span>
  <span class="nv">OLD_IMAGE_TAG</span><span class="o">=</span><span class="sb">`</span>rpm <span class="nt">-q</span> <span class="nt">--info</span> <span class="s2">"nginx"</span> | <span class="nb">grep</span> <span class="s2">"Release     : "</span> | <span class="nb">cut</span> <span class="nt">-b</span> 15-<span class="sb">`</span>
  <span class="nb">echo</span> <span class="s2">"docker.io/library/nginx:</span><span class="k">${</span><span class="nv">OLD_IMAGE_TAG</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="s2">"/tmp/nginx.old_image"</span>

  podman ps <span class="nt">-a</span> <span class="nt">--format</span><span class="o">=</span><span class="s2">"</span><span class="se">\{\{</span><span class="s2"> </span><span class="se">\.</span><span class="s2">ID </span><span class="se">\}\}</span><span class="s2"> </span><span class="se">\{\{</span><span class="s2"> .Image </span><span class="se">\}\}</span><span class="s2">"</span> | <span class="nb">grep </span>docker.io/library/nginx | <span class="nb">cut</span> <span class="nt">-b</span> <span class="nt">-12</span> <span class="o">&gt;</span> <span class="s2">"/tmp/nginx.old_containers"</span>
  podman ps <span class="nt">--format</span><span class="o">=</span><span class="s1">'\{\{ \.ID \}\} \{\{ .Image \}\}'</span> | <span class="nb">grep </span>docker.io/library/nginx | <span class="nb">cut</span> <span class="nt">-b</span> <span class="nt">-12</span> <span class="o">&gt;</span> <span class="s2">"/tmp/nginx.running_containers"</span>
<span class="k">fi</span>
</pre></table></code></div></div><blockquote class="prompt-note"><p>Please remove escape char <code class="language-plaintext highlighter-rouge">\</code> from the format. I’ve used it because the blog site generator assumes it as a variable.</p></blockquote><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>%post
podman load <span class="nt">-i</span> <span class="s2">"/opt/docker-rpm/nginx/nginx-1.28.tar"</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Post Installing nginx"</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 2 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Post Upgrading nginx"</span>
    
  podman stop <span class="si">$(</span><span class="nb">cat</span> <span class="s2">"/tmp/nginx.running_containers"</span><span class="si">)</span>

  <span class="nb">cat</span> /tmp/nginx.running_containers | <span class="k">while </span><span class="nb">read </span>CONTAINER_ID
  <span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"Upgrading </span><span class="k">${</span><span class="nv">CONTAINER_ID</span><span class="k">}</span><span class="s2">"</span>

    <span class="c"># Find the command used to create the container</span>
    <span class="nv">CREATE_COMMAND</span><span class="o">=</span><span class="sb">`</span>podman inspect <span class="k">${</span><span class="nv">CONTAINER_ID</span><span class="k">}</span> | jq <span class="nt">-M</span> <span class="nt">-r</span> <span class="s1">'.[0].Config.CreateCommand |= .[:-1] | .[0].Config.CreateCommand | join(" ")'</span><span class="sb">`</span>

    <span class="c"># Remvoe the old container</span>
    podman <span class="nb">rm</span> <span class="nt">-f</span> <span class="k">${</span><span class="nv">CONTAINER_ID</span><span class="k">}</span>

    <span class="c"># Run or Create the container</span>
    <span class="nv">NEW_CONTAINER_ID</span><span class="o">=</span><span class="sb">`</span><span class="k">${</span><span class="nv">CREATE_COMMAND</span><span class="k">}</span> <span class="nt">-d</span> docker.io/library/nginx:1.28<span class="sb">`</span>

    <span class="c"># Start the container in case the create_command is just creating the container</span>
    podman start <span class="k">${</span><span class="nv">NEW_CONTAINER_ID</span><span class="k">}</span>
  <span class="k">done
    
fi</span>
</pre></table></code></div></div><blockquote class="prompt-note"><p>Please note that <code class="language-plaintext highlighter-rouge">CreateCommand</code> section is only available in <code class="language-plaintext highlighter-rouge">podman</code>. You may have to tweak the command to find the container command.</p></blockquote><li><p>We need to clean up the old images on target system when user upgrades the package. <code class="language-plaintext highlighter-rouge">%preun</code> script runs both at after upgrade and before uninstalling. It gets an argument to differentiate between the 2 cases.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Pre Uninstall while Upgrading nginx"</span>
  <span class="nv">OLD_IMAGE</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="s2">"/tmp/nginx.old_image"</span><span class="sb">`</span>
  podman image <span class="nb">rm</span> <span class="k">${</span><span class="nv">OLD_IMAGE</span><span class="k">}</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 0 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Pre Uninstalling nginx"</span>
<span class="k">fi</span>
</pre></table></code></div></div><li><p>We need to clean up the image on target system when user choses to uninstall the package. <code class="language-plaintext highlighter-rouge">podman</code> or <code class="language-plaintext highlighter-rouge">docker</code> requires us to stop and remove any containers before deleting any image. So here we will have to update the <code class="language-plaintext highlighter-rouge">%preun</code> script and create a <code class="language-plaintext highlighter-rouge">%postun</code> script.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>%preun
<span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Pre Uninstall while Upgrading nginx"</span>
  <span class="nv">OLD_IMAGE</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="s2">"/tmp/nginx.old_image"</span><span class="sb">`</span>
  podman image <span class="nb">rm</span> <span class="k">${</span><span class="nv">OLD_IMAGE</span><span class="k">}</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 0 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Pre Uninstalling nginx"</span>

  podman ps <span class="nt">-a</span> <span class="nt">--format</span><span class="o">=</span><span class="s2">"</span><span class="se">\{\{</span><span class="s2"> </span><span class="se">\.</span><span class="s2">ID </span><span class="se">\}\}</span><span class="s2"> </span><span class="se">\{\{</span><span class="s2"> .Image </span><span class="se">\}\}</span><span class="s2">"</span> | <span class="nb">grep </span>docker.io/library/nginx | <span class="nb">cut</span> <span class="nt">-b</span> <span class="nt">-12</span> <span class="o">&gt;</span> <span class="s2">"/tmp/nginx.containers"</span>
  podman stop <span class="si">$(</span><span class="nb">cat</span> <span class="s2">"/tmp/nginx.containers"</span><span class="si">)</span>
  podman <span class="nb">rm</span> <span class="nt">-f</span> <span class="si">$(</span><span class="nb">cat</span> <span class="s2">"/tmp/nginx.containers"</span><span class="si">)</span>
<span class="k">fi</span>
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>%postun
<span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Post Uninstall while Upgrading nginx"</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 0 <span class="o">]</span><span class="p">;</span><span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Post Uninstalling nginx"</span>

  podman image <span class="nb">rm</span> <span class="nt">-f</span> docker.io/library/nginx:1.28
  <span class="nb">rm</span> <span class="nt">-Rf</span> /opt/docker-rpm/nginx
<span class="k">fi</span>
</pre></table></code></div></div></ul><h3 id="building-rpm"><span class="me-2">Building RPM</span><a href="#building-rpm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now we our spec file is ready to be used. We need to update <code class="language-plaintext highlighter-rouge">%_topdir</code> in the macrofile as we changed the build area from the default build area.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s2">"%_topdir /tmp/docker-to-rmp/rpmbuild/"</span> <span class="o">&gt;&gt;</span> /tmp/docker-to-rmp/.rpmmacros
</pre></table></code></div></div><p>Finally we can fire the <code class="language-plaintext highlighter-rouge">rpmbuild</code> command to build the package.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rpmbuild <span class="nt">--load</span><span class="o">=</span>/tmp/docker-to-rmp/.rpmmacros <span class="nt">-bb</span> /tmp/docker-to-rmp/rpmbuild/SPECS/nginx.spec
</pre></table></code></div></div><blockquote class="prompt-tip"><p>You can define multiple macros in a single file and You can use multiple <code class="language-plaintext highlighter-rouge">--load=</code> flags to specify multiple macro files.</p></blockquote><h2 id="using-systemctl-to-manage-the-container"><span class="me-2">Using <code class="language-plaintext highlighter-rouge">systemctl</code> to manage the container</span><a href="#using-systemctl-to-manage-the-container" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We can wrap the <code class="language-plaintext highlighter-rouge">podman</code> commands under a service file as well to make it easy for IT Admins to start/stop the container. To do that first we need to create a service file like below:</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>[<span class="n">Unit</span>]
<span class="n">Description</span>=<span class="n">Docker</span> <span class="n">to</span> <span class="n">RPM</span>
<span class="n">Requires</span>=<span class="n">network</span>-<span class="n">online</span>.<span class="n">target</span>
<span class="n">After</span>=<span class="n">network</span>-<span class="n">online</span>.<span class="n">target</span>

[<span class="n">Service</span>]
<span class="n">Type</span>=<span class="n">simple</span>

<span class="n">ExecStartPre</span>=<span class="n">podman</span> <span class="n">container</span> <span class="n">create</span> --<span class="n">rm</span> --<span class="n">publish</span>-<span class="n">all</span> --<span class="n">label</span> <span class="s2">"managed_by=docker-to-rpm"</span> --<span class="n">name</span> <span class="n">nginx</span> <span class="n">docker</span>.<span class="n">io</span>/<span class="n">library</span>/<span class="n">nginx</span>:<span class="m">1</span>.<span class="m">28</span>
<span class="n">ExecStart</span>=<span class="n">podman</span> <span class="n">container</span> <span class="n">start</span> <span class="n">nginx</span>
<span class="c"># ExecReload=
</span><span class="n">ExecStop</span>=<span class="n">podman</span> <span class="n">container</span> <span class="n">stop</span> <span class="n">nginx</span>
<span class="c"># ExecStopPost=
</span>
<span class="n">TimeoutStartSec</span>=<span class="m">120</span>
<span class="n">TimeoutStopSec</span>=<span class="m">60</span>

<span class="c"># Restart behavior:
# Restart the service if it fails, with a delay, to make it restart-safe
</span><span class="n">Restart</span>=<span class="n">on</span>-<span class="n">failure</span>
<span class="n">RestartSec</span>=<span class="m">10</span><span class="n">s</span>

[<span class="n">Install</span>]
<span class="n">WantedBy</span>=<span class="n">multi</span>-<span class="n">user</span>.<span class="n">target</span>
</pre></table></code></div></div><p>Next we would need to update our different scripts for <code class="language-plaintext highlighter-rouge">systemctl</code> support.</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre>%install
podman image pull docker.io/library/nginx:1.28
podman image save docker.io/library/nginx:1.28 <span class="nt">-o</span> <span class="s2">"%{buildroot}/opt/docker-rpm/nginx/nginx-1.28.tar"</span>

%pre
<span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Pre Installing nginx"</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 2 <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Pre Upgrading nginx"</span>
    <span class="k">if </span>systemctl is-enabled <span class="nt">--quiet</span> nginx.service <span class="o">&amp;&amp;</span> systemctl is-active <span class="nt">--quiet</span> nginx.service <span class="p">;</span> <span class="k">then
        </span>systemctl stop nginx.service
    <span class="k">fi
    </span><span class="nv">OLD_IMAGE_TAG</span><span class="o">=</span><span class="sb">`</span>rpm <span class="nt">-q</span> <span class="nt">--info</span> <span class="s2">"nginx"</span> | <span class="nb">grep</span> <span class="s2">"Release     : "</span> | <span class="nb">cut</span> <span class="nt">-b</span> 15-<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">"docker.io/library/nginx:</span><span class="k">${</span><span class="nv">OLD_IMAGE_TAG</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="s2">"/tmp/nginx.old_image"</span>
<span class="k">fi</span>

%post
podman load <span class="nt">-i</span> <span class="s2">"/opt/docker-rpm/nginx/nginx-1.28.tar"</span>
systemctl daemon-reload

<span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Post Installing nginx"</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 2 <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Post Upgrading nginx"</span>
    <span class="k">if </span>systemctl is-enabled <span class="nt">--quiet</span> nginx.service <span class="p">;</span> <span class="k">then
        </span>systemctl start nginx.service
    <span class="k">fi
fi</span>

%preun
<span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Pre Uninstall while Upgrading nginx"</span>
    <span class="nv">OLD_IMAGE</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="s2">"/tmp/nginx.old_image"</span><span class="sb">`</span>
    podman image <span class="nb">rm</span> <span class="k">${</span><span class="nv">OLD_IMAGE</span><span class="k">}</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 0 <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Pre Uninstalling nginx"</span>
    systemctl disable nginx.service
    systemctl stop nginx.service
<span class="k">fi</span>

%postun
<span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Post Uninstall while Upgrading nginx"</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> 0 <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Post Uninstalling nginx"</span>
    <span class="nb">rm</span> <span class="nt">-Rf</span> <span class="s2">"/opt/docker-rpm/nginx/"</span>
    <span class="nb">rm</span> <span class="nt">-f</span> <span class="s2">"/etc/systemd/system/nginx.service"</span>

    systemctl daemon-reload

    podman container <span class="nb">rm</span> <span class="nt">-f</span> nginx
    podman image <span class="nb">rm</span> <span class="nt">-f</span> docker.io/library/nginx:1.28
<span class="k">fi</span>
</pre></table></code></div></div><blockquote class="prompt-info"><p>Here we are assuming that there will be only 1 container for the image and the container is being managed by the <code class="language-plaintext highlighter-rouge">systemctl</code> service file.</p></blockquote><p>The service file above doesn’t direct the container logs to <code class="language-plaintext highlighter-rouge">journalctl</code> command. To do that we need to update our service file to attach the <code class="language-plaintext highlighter-rouge">stdout</code> and <code class="language-plaintext highlighter-rouge">stderr</code> to the container.</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>...
[<span class="n">Service</span>]
<span class="n">Type</span>=<span class="n">exec</span>
...
<span class="n">ExecStart</span>=<span class="n">podman</span> <span class="n">container</span> <span class="n">start</span> --<span class="n">attach</span> <span class="n">nginx</span>
...
</pre></table></code></div></div><blockquote class="prompt-tip"><p>Please note that I’ve changed the service <code class="language-plaintext highlighter-rouge">Type</code> as well to indicate that <code class="language-plaintext highlighter-rouge">systemctl</code> should treat the service to be up as long as the command is running.</p></blockquote><p>The Service file is exposing all the ports which container exposes to random ports on the host. We can fix the ports in service file as shown below:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>...
<span class="o">[</span>Service]
...
<span class="nv">ExecStartPre</span><span class="o">=</span>podman container create <span class="nt">--rm</span> <span class="nt">-p</span> <span class="s2">"8080:80"</span> <span class="nt">--label</span> <span class="s2">"managed_by=docker-to-rpm"</span> <span class="nt">--name</span> nginx docker.io/library/nginx:1.28
...
</pre></table></code></div></div><h2 id="managing-multi-container-workloads"><span class="me-2">Managing multi-container workloads</span><a href="#managing-multi-container-workloads" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Most of the time we develop applications which depends on other applications like Database, Cache and so on. We can adapt above steps to orchestrate multiple containers as well. Here <code class="language-plaintext highlighter-rouge">podman</code>’s <code class="language-plaintext highlighter-rouge">compose</code> plugin can come handy to manage and connect multiple containers together.</p><p>We can use multiple strategies to manage the containers via <code class="language-plaintext highlighter-rouge">podman</code>’s <code class="language-plaintext highlighter-rouge">compose</code> plugin. I’ve tried to list few of them below:</p><ul><li>We can put multiple containers in a single RPM file along with single compose file.<li>We can have multiple app RPMs and 1 compose file RPM to orchestrate the application.<li>We can create multiple RPMs and have with app specific compose file for each RPM. And then combine multiple compose files with <code class="language-plaintext highlighter-rouge">-f</code> flag.</ul><p>Creating Multiple RPMs with their specific compose file is the best option in my opinion as it give you the freedom to manage upgrades for the different components separately.</p><h2 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Containers are becoming defacto standard for shipping new software. IT Admins have to adopt new workflows to install containerized workloads on Airgapped systems. It is a tedious job to export and deploy containerized workloads. We can ease their lifes by packaging the containers as standard packages and then wrapping orchestration part as <code class="language-plaintext highlighter-rouge">systemctl</code> services. This provides a better control to the Software vendor in managing their software in Airgapped installations.</p><p>I’ve created a python script to automate RPM creation for a given <code class="language-plaintext highlighter-rouge">docker</code> image. You can download it from <a href="https://github.com/bikram990/blog-examples/tree/main/2025-07-26-ship-docker-images-to-airgaped-using-rpms">GitHub</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/blogs/">blogs</a>, <a href="/categories/tech/">tech</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a> <a href="/tags/rpms/" class="post-tag no-text-decoration" >rpms</a> <a href="/tags/airgapped/" class="post-tag no-text-decoration" >airgapped</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Ship%20Docker%20images%20to%20airgapped%20systems%20using%20rpms%20-%20Bikramjeet%20Singh&url=https%3A%2F%2Fblogs.bikramjs.in%2Fposts%2Fship-docker-images-to-airgaped-using-rpms%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Ship%20Docker%20images%20to%20airgapped%20systems%20using%20rpms%20-%20Bikramjeet%20Singh&u=https%3A%2F%2Fblogs.bikramjs.in%2Fposts%2Fship-docker-images-to-airgaped-using-rpms%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblogs.bikramjs.in%2Fposts%2Fship-docker-images-to-airgaped-using-rpms%2F&text=Ship%20Docker%20images%20to%20airgapped%20systems%20using%20rpms%20-%20Bikramjeet%20Singh" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fblogs.bikramjs.in%2Fposts%2Fship-docker-images-to-airgaped-using-rpms%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/creating-l3-l4-load-balancer/">Let's Balance the load Part 2 - L3/L4</a><li class="text-truncate lh-lg"> <a href="/posts/dev-containers/">Consistent Development environments using devcontainers</a><li class="text-truncate lh-lg"> <a href="/posts/ship-docker-images-to-airgaped-using-rpms/">Ship Docker images to airgapped systems using rpms</a><li class="text-truncate lh-lg"> <a href="/posts/building-gcc-on-solaris/">Building gcc 4.1.2 on Solaris 10</a><li class="text-truncate lh-lg"> <a href="/posts/solaris-packaging/">Solaris Package creation with relocation support</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/loadbalancer/">loadbalancer</a> <a class="post-tag btn btn-outline-primary" href="/tags/networking/">networking</a> <a class="post-tag btn btn-outline-primary" href="/tags/airgapped/">airgapped</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/solaris/">solaris</a> <a class="post-tag btn btn-outline-primary" href="/tags/devcontainers/">devcontainers</a> <a class="post-tag btn btn-outline-primary" href="/tags/development/">development</a> <a class="post-tag btn btn-outline-primary" href="/tags/environments/">environments</a> <a class="post-tag btn btn-outline-primary" href="/tags/gcc/">gcc</a> <a class="post-tag btn btn-outline-primary" href="/tags/l3-l4-lb/">l3/l4-lb</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/ship-docker-images-to-airgaped/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1752805800" data-df="ll" > Jul 18, 2025 </time><h4 class="pt-0 my-2">Ship Docker images to airgapped systems</h4><div class="text-muted"><p>Shipping Docker images to an airgapped system can be challenging due to no internet connectivity. Let see how we can ship `docker` images to an airgapped system.</p></div></div></a></article><article class="col"> <a href="/posts/dev-containers/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1751769000" data-df="ll" > Jul 6, 2025 </time><h4 class="pt-0 my-2">Consistent Development environments using devcontainers</h4><div class="text-muted"><p>Leveraging `docker` containers for providing reusable, replicable and consistent development enviorment.</p></div></div></a></article><article class="col"> <a href="/posts/creating-l7-load-balancer/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1745461800" data-df="ll" > Apr 24, 2025 </time><h4 class="pt-0 my-2">Let's Balance the load Part 3 - L7</h4><div class="text-muted"><p>At L7 level we use reverse proxies to expose our services to the clients and these reverse proxies forwards the traffic to the actual servers based on various load balancing algorithms.</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/ship-docker-images-to-airgaped/" class="btn btn-outline-primary" aria-label="Older" ><p>Ship Docker images to airgapped systems</p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/bikram990">Bikramjeet Singh</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/loadbalancer/">loadbalancer</a> <a class="post-tag btn btn-outline-primary" href="/tags/networking/">networking</a> <a class="post-tag btn btn-outline-primary" href="/tags/airgapped/">airgapped</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/solaris/">solaris</a> <a class="post-tag btn btn-outline-primary" href="/tags/devcontainers/">devcontainers</a> <a class="post-tag btn btn-outline-primary" href="/tags/development/">development</a> <a class="post-tag btn btn-outline-primary" href="/tags/environments/">environments</a> <a class="post-tag btn btn-outline-primary" href="/tags/gcc/">gcc</a> <a class="post-tag btn btn-outline-primary" href="/tags/l3-l4-lb/">l3/l4-lb</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'bikram990/bikram990.github.io', 'data-repo-id': 'R_kgDOOaJ1uA', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOOaJ1uM4CrqHt', 'data-mapping': 'pathname', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'top', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
